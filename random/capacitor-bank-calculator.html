<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3-Phase Capacitor Bank Calculator</title>
    <link rel="stylesheet" href="tokens.css">
    <style>
        .main-layout {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: var(--space-lg);
        }

        .config-panel {
            padding: var(--space-lg);
            background: var(--bg-subtle);
            border-radius: var(--radius-md);
            max-height: calc(100vh - 160px);
            overflow-y: auto;
        }

        .section-title {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: var(--space-lg) 0 var(--space-md) 0;
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid var(--bg-hover);
        }

        .section-title:first-child {
            margin-top: 0;
        }

        .input-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-md);
        }

        .phase-section {
            background: var(--bg);
            border-radius: var(--radius-sm);
            padding: var(--space-md);
            margin-bottom: var(--space-md);
        }

        .phase-section h4 {
            margin: 0 0 var(--space-md) 0;
            font-size: 0.875rem;
        }

        .phase-A h4 { color: var(--phase-a); }
        .phase-B h4 { color: var(--phase-b); }
        .phase-C h4 { color: var(--phase-c); }

        .branch-section {
            margin-left: var(--space-md);
            padding-left: var(--space-md);
            border-left: 2px solid var(--bg-hover);
            margin-bottom: var(--space-sm);
        }

        .can-row {
            display: grid;
            grid-template-columns: 1fr 80px;
            gap: var(--space-sm);
            margin-bottom: var(--space-xs);
        }

        .apply-btn {
            width: 100%;
            margin-top: var(--space-md);
            padding: var(--space-sm) var(--space-md);
            background: var(--text);
            border: none;
            border-radius: var(--radius-sm);
            color: var(--bg);
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
        }

        .apply-btn:hover {
            opacity: 0.9;
        }

        .apply-btn.secondary {
            background: var(--bg-hover);
            color: var(--text-secondary);
        }

        .apply-btn.secondary:hover {
            background: var(--bg);
        }

        .results-panel {
            padding: var(--space-lg);
            background: var(--bg-subtle);
            border-radius: var(--radius-md);
        }

        .results-panel h2 {
            font-size: 1rem;
            margin-bottom: var(--space-lg);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
        }

        .summary-item {
            background: var(--bg);
            padding: var(--space-lg);
            border-radius: var(--radius-sm);
            text-align: center;
        }

        .summary-item .label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: var(--space-xs);
        }

        .summary-item .value {
            font-size: 1.5rem;
            font-weight: 600;
            font-family: var(--font-mono);
            color: var(--text);
        }

        .summary-item .unit {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .results-output {
            background: var(--bg);
            padding: var(--space-lg);
            border-radius: var(--radius-sm);
            font-family: var(--font-mono);
            font-size: 0.8rem;
            line-height: 1.6;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        .results-output .value { color: var(--text); font-weight: 600; }
        .results-output .warning { color: var(--warning); }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-size: 0.875rem;
        }

        .checkbox-label input {
            accent-color: var(--text);
        }

        @media (max-width: 1000px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            .summary-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <a href="/random/" class="header-back">← Relay Tools</a>
            <span class="header-title">Cap Bank Calculator</span>
        </header>

        <h1>3-Phase Capacitor Bank Calculator</h1>
        <p class="tagline">Calculate capacitor bank VAR output and voltage distribution</p>

        <div class="main-layout">
            <div class="config-panel">
                <div class="section-title">System Parameters</div>
                <div class="input-grid">
                    <div class="input-group">
                        <label>Frequency (Hz)</label>
                        <input type="number" id="frequency" value="60">
                    </div>
                    <div class="input-group">
                        <label>Line-to-Line Voltage (V)</label>
                        <input type="number" id="voltage_ll" value="115000">
                    </div>
                    <div class="input-group">
                        <label>Connection</label>
                        <select id="connection">
                            <option value="wye">Grounded Wye</option>
                            <option value="delta">Delta</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Can Type</label>
                        <select id="can_type">
                            <option value="fused">Internally Fused</option>
                            <option value="fuseless" selected>Fuseless</option>
                        </select>
                    </div>
                </div>

                <div class="section-title">Bank Configuration</div>
                <div class="input-grid">
                    <div class="input-group">
                        <label>Parallel Branches</label>
                        <input type="number" id="num_parallel" value="2" min="1">
                    </div>
                    <div class="input-group">
                        <label>Series Cans per Branch</label>
                        <input type="number" id="num_series" value="4" min="1">
                    </div>
                    <div class="input-group">
                        <label>Uniform Capacitance (µF)</label>
                        <input type="number" id="uniform_C" value="4.81" step="0.01">
                    </div>
                    <div class="input-group">
                        <label>Series Groups per Can</label>
                        <input type="number" id="series_groups" value="8" min="1">
                    </div>
                    <div class="input-group">
                        <label>Parallel Elements per Group</label>
                        <input type="number" id="parallel_elements" value="1" min="1">
                    </div>
                </div>
                <button class="apply-btn" onclick="setUniformMain()">Apply Uniform Configuration</button>

                <div class="section-title">Voltage Divider (Grounded Wye)</div>
                <div class="input-grid">
                    <div class="input-group">
                        <label class="checkbox-label"><input type="checkbox" id="enable_divider" checked> Enable Divider</label>
                    </div>
                    <div class="input-group">
                        <label>Divider Capacitance (µF)</label>
                        <input type="number" id="uniform_div_C" value="650">
                    </div>
                </div>
                <button class="apply-btn secondary" onclick="setUniformDivider()">Apply Divider</button>

                <div class="section-title">Series Reactor</div>
                <div class="input-grid">
                    <div class="input-group">
                        <label class="checkbox-label"><input type="checkbox" id="enable_reactor"> Enable Reactor</label>
                    </div>
                    <div class="input-group">
                        <label>Inductance (mH)</label>
                        <input type="number" id="uniform_L" value="1">
                    </div>
                </div>
                <button class="apply-btn secondary" onclick="setUniformReactor()">Apply Reactor</button>

                <div class="section-title">Per-Phase Configuration</div>
                <div id="phases"></div>

                <button class="apply-btn" onclick="compute()" style="margin-top: var(--space-xl);">Calculate</button>
            </div>

            <div class="results-panel">
                <h2>Results</h2>

                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="label">Total Reactive Power</div>
                        <div class="value" id="totalMVAR">--</div>
                        <div class="unit">MVAR</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">Line Current</div>
                        <div class="value" id="lineCurrent">--</div>
                        <div class="unit">A</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">Phase Voltage</div>
                        <div class="value" id="phaseVoltage">--</div>
                        <div class="unit">kV</div>
                    </div>
                </div>

                <div class="results-output" id="results"></div>
            </div>
        </div>

        <div class="drawer-trigger" id="stepToggle">See formulas →</div>
        <div class="step-content" id="stepContent">
<div class="step-section">
<div class="step-title">Capacitor Bank Calculations (IEEE Std 18)</div>
<pre>
Phase Voltage:
  Wye:   V_ph = V_LL / √3
  Delta: V_ph = V_LL

Capacitive Reactance:
  X_C = 1 / (2πfC)

Phase Current:
  I_ph = V_ph / X_C = 2πfC × V_ph

Reactive Power (per phase):
  Q_ph = V_ph × I_ph = 2πfC × V_ph²

Total 3-Phase:
  Q_total = 3 × Q_ph

Line Current:
  Wye:   I_line = I_ph
  Delta: I_line = √3 × I_ph
</pre>
</div>
<div class="step-section">
<div class="step-title">Effective Capacitance with Failed Elements</div>
<pre>
Fuseless (shorted elements):
  C_eff = C_nom × S / (S - n_failed)
  where S = series groups

Fused (open elements):
  Elements are distributed across series groups
  Each group: C_group = (P - k) / P × C_group_nom
  where P = parallel elements, k = failed in that group
</pre>
</div>
        </div>
    </div>

    <script>
        let phases = {
            A: { branches: [], divider: {nominal: 0, failed: 0}, reactor: 0 },
            B: { branches: [], divider: {nominal: 0, failed: 0}, reactor: 0 },
            C: { branches: [], divider: {nominal: 0, failed: 0}, reactor: 0 }
        };

        function renderPhases() {
            const container = document.getElementById('phases');
            container.innerHTML = '';
            const phaseColors = {'A': 'var(--phase-a)', 'B': 'var(--phase-b)', 'C': 'var(--phase-c)'};

            for (let phase in phases) {
                const phaseDiv = document.createElement('div');
                phaseDiv.className = `phase-section phase-${phase}`;
                phaseDiv.innerHTML = `<h4>Phase ${phase}</h4>`;

                const reactDiv = document.createElement('div');
                reactDiv.className = 'input-group';
                reactDiv.innerHTML = `<label>Reactor (mH)</label>
                    <input type="number" value="${phases[phase].reactor * 1000}"
                           onchange="updateReactor('${phase}', this.value)" step="0.1">`;
                phaseDiv.appendChild(reactDiv);

                const divDiv = document.createElement('div');
                divDiv.className = 'can-row';
                divDiv.innerHTML = `
                    <input type="number" value="${phases[phase].divider.nominal * 1e6}"
                           onchange="updateDividerNominal('${phase}', this.value)" placeholder="Divider µF">
                    <input type="number" value="${phases[phase].divider.failed}"
                           onchange="updateDividerFailed('${phase}', this.value)" placeholder="Failed">`;
                phaseDiv.appendChild(divDiv);

                phases[phase].branches.forEach((branch, bIdx) => {
                    const branchDiv = document.createElement('div');
                    branchDiv.className = 'branch-section';
                    branchDiv.innerHTML = `<strong style="font-size:0.75rem;color:${phaseColors[phase]}">Branch ${bIdx + 1}</strong>`;

                    branch.forEach((can, sIdx) => {
                        const canDiv = document.createElement('div');
                        canDiv.className = 'can-row';
                        canDiv.innerHTML = `
                            <input type="number" value="${(can.nominal * 1e6).toFixed(2)}"
                                   onchange="updateCanNominal('${phase}', ${bIdx}, ${sIdx}, this.value)"
                                   placeholder="Can ${sIdx + 1} µF" step="0.01">
                            <input type="number" value="${can.failed}"
                                   onchange="updateCanFailed('${phase}', ${bIdx}, ${sIdx}, this.value)"
                                   placeholder="Failed" min="0">`;
                        branchDiv.appendChild(canDiv);
                    });
                    phaseDiv.appendChild(branchDiv);
                });

                container.appendChild(phaseDiv);
            }
        }

        function setUniformMain() {
            const numParallel = parseInt(document.getElementById('num_parallel').value);
            const numSeries = parseInt(document.getElementById('num_series').value);
            const uniformC = parseFloat(document.getElementById('uniform_C').value) * 1e-6;
            for (let phase in phases) {
                phases[phase].branches = Array.from({length: numParallel}, () =>
                    Array.from({length: numSeries}, () => ({nominal: uniformC, failed: 0}))
                );
            }
            renderPhases();
        }

        function setUniformDivider() {
            const enable = document.getElementById('enable_divider').checked;
            const uniformDiv = enable ? parseFloat(document.getElementById('uniform_div_C').value) * 1e-6 : 0;
            for (let phase in phases) {
                phases[phase].divider = {nominal: uniformDiv, failed: 0};
            }
            renderPhases();
        }

        function setUniformReactor() {
            const enable = document.getElementById('enable_reactor').checked;
            const uniformL = enable ? parseFloat(document.getElementById('uniform_L').value) / 1000 : 0;
            for (let phase in phases) {
                phases[phase].reactor = uniformL;
            }
            renderPhases();
        }

        function updateCanNominal(phase, bIdx, sIdx, value) {
            phases[phase].branches[bIdx][sIdx].nominal = parseFloat(value) * 1e-6;
        }

        function updateCanFailed(phase, bIdx, sIdx, value) {
            phases[phase].branches[bIdx][sIdx].failed = parseInt(value);
        }

        function updateDividerNominal(phase, value) {
            phases[phase].divider.nominal = parseFloat(value) * 1e-6;
        }

        function updateDividerFailed(phase, value) {
            phases[phase].divider.failed = parseInt(value);
        }

        function updateReactor(phase, value) {
            phases[phase].reactor = parseFloat(value) / 1000;
        }

        function calculateEffectiveC(can_type, nominal, failed, s, p) {
            if (failed === 0) return nominal;
            if (can_type === 'fuseless') {
                if (failed >= s) return 0;
                return nominal * s / (s - failed);
            } else {
                if (failed >= s * p) return 0;
                const c_group_orig = nominal * s;
                const base_k = Math.floor(failed / s);
                const extra = failed % s;
                let inv_c_total = 0;
                for (let i = 0; i < s; i++) {
                    const k = base_k + (i < extra ? 1 : 0);
                    const effective_p = p - k;
                    if (effective_p <= 0) return 0;
                    const c_group_k = (effective_p / p) * c_group_orig;
                    inv_c_total += 1 / c_group_k;
                }
                return 1 / inv_c_total;
            }
        }

        function getMainCPhase(phase, can_type, s_groups, p_elements) {
            let C_total = 0.0;
            phases[phase].branches.forEach(branch => {
                if (branch.length === 0) return;
                let inv_C_series = 0;
                let all_valid = true;
                branch.forEach(can => {
                    const effective = calculateEffectiveC(can_type, can.nominal, can.failed, s_groups, p_elements);
                    if (effective <= 0) { all_valid = false; return; }
                    inv_C_series += 1 / effective;
                });
                if (!all_valid || inv_C_series === 0) return;
                C_total += 1 / inv_C_series;
            });
            return C_total;
        }

        function getPhaseC(phase, can_type, s_groups, p_elements) {
            const C_main = getMainCPhase(phase, can_type, s_groups, p_elements);
            const C_div_nom = phases[phase].divider.nominal;
            const div_failed = phases[phase].divider.failed;
            const C_div = calculateEffectiveC(can_type, C_div_nom, div_failed, s_groups, p_elements);
            if (C_div > 0) {
                return C_main * C_div / (C_main + C_div);
            }
            return C_main;
        }

        function getPhaseVoltage(voltage_ll, connection) {
            return connection === 'wye' ? voltage_ll / Math.sqrt(3) : voltage_ll;
        }

        function compute() {
            const frequency = parseFloat(document.getElementById('frequency').value);
            const voltage_ll = parseFloat(document.getElementById('voltage_ll').value);
            const connection = document.getElementById('connection').value;
            const can_type = document.getElementById('can_type').value;
            const s_groups = parseInt(document.getElementById('series_groups').value);
            const p_elements = parseInt(document.getElementById('parallel_elements').value);
            const omega = 2 * Math.PI * frequency;
            const V_ph = getPhaseVoltage(voltage_ll, connection);

            let resultsText = `System Configuration
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Connection: ${connection === 'wye' ? 'Grounded Wye' : 'Delta'}
Frequency: ${frequency} Hz
Line-to-Line Voltage: ${(voltage_ll/1000).toFixed(1)} kV
Phase Voltage: ${(V_ph/1000).toFixed(3)} kV
Can Type: ${can_type === 'fuseless' ? 'Fuseless' : 'Internally Fused'}

`;

            let total_Q = 0.0;
            let I_phases = [];

            for (let phase in phases) {
                const C_main = getMainCPhase(phase, can_type, s_groups, p_elements);
                const div_nom = phases[phase].divider.nominal;
                const div_failed = phases[phase].divider.failed;
                const C_div = calculateEffectiveC(can_type, div_nom, div_failed, s_groups, p_elements);
                const has_div = C_div > 0;
                const C_phase = getPhaseC(phase, can_type, s_groups, p_elements);
                const L = phases[phase].reactor;

                let I_phase, V_cap, V_reactor = 0;

                if (L > 0) {
                    const X_L = omega * L;
                    const X_C = C_phase > 0 ? 1 / (omega * C_phase) : Infinity;
                    const X_net = X_L - X_C;
                    const abs_X_net = Math.abs(X_net);
                    I_phase = abs_X_net === 0 ? Infinity : V_ph / abs_X_net;
                    V_cap = I_phase * Math.abs(X_C);
                    V_reactor = I_phase * X_L;
                } else {
                    I_phase = omega * C_phase * V_ph;
                    V_cap = V_ph;
                }

                const Q_phase = V_ph * I_phase;
                total_Q += Q_phase;
                I_phases.push(I_phase);

                let V_main, V_div = 0;
                if (has_div) {
                    V_main = (C_div / (C_main + C_div)) * V_cap;
                    V_div = (C_main / (C_main + C_div)) * V_cap;
                } else {
                    V_main = V_cap;
                }

                resultsText += `━━━ Phase ${phase} ━━━
Main Bank C: ${(C_main * 1e6).toFixed(4)} µF
`;
                if (L > 0) {
                    resultsText += `Reactor: ${(L * 1000).toFixed(3)} mH, V_reactor: ${V_reactor.toFixed(2)} V
`;
                }
                if (has_div) {
                    resultsText += `Divider C: ${(C_div * 1e6).toFixed(2)} µF, V_tap: ${V_div.toFixed(2)} V
`;
                }
                resultsText += `Total Phase C: ${(C_phase * 1e6).toFixed(4)} µF
Phase Current: ${I_phase.toFixed(2)} A
Phase VAR: ${(Q_phase/1e6).toFixed(4)} MVAR
V_main: ${(V_main/1000).toFixed(3)} kV

`;

                phases[phase].branches.forEach((branch, bIdx) => {
                    let inv_C_series = 0;
                    let effective_cans = [];
                    let all_valid = true;
                    branch.forEach((can, sIdx) => {
                        const effective = calculateEffectiveC(can_type, can.nominal, can.failed, s_groups, p_elements);
                        effective_cans.push(effective);
                        if (effective <= 0) { all_valid = false; return; }
                        inv_C_series += 1 / effective;
                    });
                    const C_branch = all_valid && inv_C_series > 0 ? 1 / inv_C_series : 0;
                    const I_branch = omega * C_branch * V_main;

                    resultsText += `  Branch ${bIdx + 1}: C=${(C_branch * 1e6).toFixed(4)} µF, I=${I_branch.toFixed(2)} A
`;

                    branch.forEach((can, sIdx) => {
                        const effective = effective_cans[sIdx];
                        const V_can = effective > 0 ? I_branch / (omega * effective) : 0;
                        let status = can.failed > 0 ? ` [${can.failed} failed]` : '';
                        resultsText += `    Can ${sIdx + 1}: C=${(effective * 1e6).toFixed(3)} µF, V=${V_can.toFixed(1)} V${status}
`;
                    });
                });
                resultsText += '\n';
            }

            const avg_I_phase = I_phases.reduce((s, i) => s + i, 0) / 3;
            const I_line = connection === 'wye' ? avg_I_phase : Math.sqrt(3) * avg_I_phase;

            document.getElementById('totalMVAR').textContent = (total_Q / 1e6).toFixed(3);
            document.getElementById('lineCurrent').textContent = I_line.toFixed(1);
            document.getElementById('phaseVoltage').textContent = (V_ph / 1000).toFixed(2);

            resultsText += `━━━ TOTALS ━━━
Total 3-Phase VAR: ${(total_Q / 1e6).toFixed(4)} MVAR
Line Current: ${I_line.toFixed(2)} A
`;

            document.getElementById('results').textContent = resultsText;
        }

        document.getElementById('stepToggle').addEventListener('click', () => {
            document.getElementById('stepContent').classList.toggle('open');
        });

        setUniformMain();
        compute();
    </script>
</body>
</html>
