<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distance Relay Settings</title>
    <link rel="stylesheet" href="tokens.css">
    <style>
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-lg);
        }

        .input-section {
            padding: var(--space-lg);
            background: var(--bg-subtle);
            border-radius: var(--radius-md);
        }

        .section-title {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: var(--space-lg) 0 var(--space-md) 0;
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid var(--bg-hover);
        }

        .section-title:first-child { margin-top: 0; }

        .input-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-md);
        }

        .zone-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-sm);
            margin-bottom: var(--space-lg);
        }

        .zone-card {
            text-align: center;
        }

        .zone-header {
            padding: var(--space-sm);
            border-radius: var(--radius-sm) var(--radius-sm) 0 0;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .z1 .zone-header { background: rgba(10, 132, 255, 0.2); color: #0a84ff; }
        .z2 .zone-header { background: rgba(48, 209, 88, 0.2); color: #30d158; }
        .z3 .zone-header { background: rgba(255, 214, 10, 0.2); color: #ffd60a; }
        .z4 .zone-header { background: rgba(175, 82, 222, 0.2); color: #af52de; }

        .zone-value {
            background: var(--bg-subtle);
            padding: var(--space-md);
            border-radius: 0 0 var(--radius-sm) var(--radius-sm);
            font-family: var(--font-mono);
            font-size: 1.1rem;
        }

        .zone-unit {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .setting-row {
            display: grid;
            grid-template-columns: 100px 1fr 100px;
            gap: var(--space-md);
            padding: var(--space-md);
            background: var(--bg-subtle);
            border-radius: var(--radius-sm);
            margin-bottom: var(--space-sm);
            align-items: center;
        }

        .setting-name { font-weight: 600; font-size: 0.9rem; }
        .setting-value { font-family: var(--font-mono); text-align: right; }
        .setting-unit { font-size: 0.75rem; color: var(--text-muted); }

        .canvas-container {
            margin-top: var(--space-lg);
            display: flex;
            justify-content: center;
        }

        @media (max-width: 800px) {
            .main-layout { grid-template-columns: 1fr; }
            .zone-grid { grid-template-columns: repeat(2, 1fr); }
            .input-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <a href="/random/" class="header-back">← Relay Tools</a>
            <span class="header-title">Distance Relay</span>
        </header>

        <h1>Distance Relay Settings</h1>
        <p class="tagline">Calculate zone reaches and relay settings</p>

        <div class="main-layout">
            <div class="input-section">
                <div class="section-title">Line Parameters</div>
                <div class="input-grid">
                    <div class="input-group">
                        <label>Line Length (mi)</label>
                        <input type="number" id="lineLength" value="50" step="0.1">
                    </div>
                    <div class="input-group">
                        <label>System kV (L-L)</label>
                        <input type="number" id="systemKV" value="138">
                    </div>
                    <div class="input-group">
                        <label>Z1 (Ω/mi)</label>
                        <input type="number" id="z1PerMile" value="0.1" step="0.001">
                    </div>
                    <div class="input-group">
                        <label>Z1 Angle (°)</label>
                        <input type="number" id="z1Angle" value="85">
                    </div>
                    <div class="input-group">
                        <label>Z0/Z1 Ratio</label>
                        <input type="number" id="z0z1Ratio" value="3" step="0.1">
                    </div>
                    <div class="input-group">
                        <label>Z0 Angle (°)</label>
                        <input type="number" id="z0Angle" value="80">
                    </div>
                </div>

                <div class="section-title">Instrument Transformers</div>
                <div class="input-grid">
                    <div class="input-group">
                        <label>CT Ratio</label>
                        <input type="text" id="ctRatio" value="2000:5">
                    </div>
                    <div class="input-group">
                        <label>PT Ratio</label>
                        <input type="text" id="ptRatio" value="1200:1">
                    </div>
                </div>

                <div class="section-title">Zone Coverage (%)</div>
                <div class="input-grid">
                    <div class="input-group">
                        <label>Zone 1</label>
                        <input type="number" id="z1Coverage" value="80">
                    </div>
                    <div class="input-group">
                        <label>Zone 2</label>
                        <input type="number" id="z2Coverage" value="120">
                    </div>
                    <div class="input-group">
                        <label>Zone 3</label>
                        <input type="number" id="z3Coverage" value="150">
                    </div>
                    <div class="input-group">
                        <label>Zone 4 (Rev)</label>
                        <input type="number" id="z4Coverage" value="25">
                    </div>
                </div>
            </div>

            <div>
                <div class="section-title">Zone Reaches (Primary Ω)</div>
                <div class="zone-grid">
                    <div class="zone-card z1">
                        <div class="zone-header">Zone 1</div>
                        <div class="zone-value" id="z1_reach">--</div>
                        <div class="zone-unit">Ω</div>
                    </div>
                    <div class="zone-card z2">
                        <div class="zone-header">Zone 2</div>
                        <div class="zone-value" id="z2_reach">--</div>
                        <div class="zone-unit">Ω</div>
                    </div>
                    <div class="zone-card z3">
                        <div class="zone-header">Zone 3</div>
                        <div class="zone-value" id="z3_reach">--</div>
                        <div class="zone-unit">Ω</div>
                    </div>
                    <div class="zone-card z4">
                        <div class="zone-header">Zone 4</div>
                        <div class="zone-value" id="z4_reach">--</div>
                        <div class="zone-unit">Ω</div>
                    </div>
                </div>

                <div class="section-title">Relay Settings (Secondary)</div>
                <div class="setting-row">
                    <span class="setting-name">Z1MAG</span>
                    <span class="setting-value" id="Z1MAG">--</span>
                    <span class="setting-unit">Ω sec</span>
                </div>
                <div class="setting-row">
                    <span class="setting-name">Z1ANG</span>
                    <span class="setting-value" id="Z1ANG">--</span>
                    <span class="setting-unit">degrees</span>
                </div>
                <div class="setting-row">
                    <span class="setting-name">Z2MAG</span>
                    <span class="setting-value" id="Z2MAG">--</span>
                    <span class="setting-unit">Ω sec</span>
                </div>
                <div class="setting-row">
                    <span class="setting-name">Z3MAG</span>
                    <span class="setting-value" id="Z3MAG">--</span>
                    <span class="setting-unit">Ω sec</span>
                </div>
                <div class="setting-row">
                    <span class="setting-name">Z4MAG</span>
                    <span class="setting-value" id="Z4MAG">--</span>
                    <span class="setting-unit">Ω sec</span>
                </div>
                <div class="setting-row">
                    <span class="setting-name">k0M</span>
                    <span class="setting-value" id="k0M">--</span>
                    <span class="setting-unit">magnitude</span>
                </div>
                <div class="setting-row">
                    <span class="setting-name">k0A</span>
                    <span class="setting-value" id="k0A">--</span>
                    <span class="setting-unit">degrees</span>
                </div>

                <div class="canvas-container">
                    <canvas id="zoneCanvas" width="400" height="350"></canvas>
                </div>
            </div>
        </div>

        <div class="drawer-trigger" id="stepToggle">See calculations →</div>
        <div class="step-content" id="stepContent"></div>
    </div>

    <script>
        function parseRatio(str) {
            const parts = str.split(':').map(s => parseFloat(s.trim()));
            return parts[0] / parts[1];
        }

        function calculate() {
            const lineLength = parseFloat(document.getElementById('lineLength').value);
            const z1PerMile = parseFloat(document.getElementById('z1PerMile').value);
            const z1Angle = parseFloat(document.getElementById('z1Angle').value);
            const z0z1Ratio = parseFloat(document.getElementById('z0z1Ratio').value);
            const z0Angle = parseFloat(document.getElementById('z0Angle').value);

            const CTR = parseRatio(document.getElementById('ctRatio').value);
            const PTR = parseRatio(document.getElementById('ptRatio').value);

            const z1Coverage = parseFloat(document.getElementById('z1Coverage').value) / 100;
            const z2Coverage = parseFloat(document.getElementById('z2Coverage').value) / 100;
            const z3Coverage = parseFloat(document.getElementById('z3Coverage').value) / 100;
            const z4Coverage = parseFloat(document.getElementById('z4Coverage').value) / 100;

            const Z1_line = z1PerMile * lineLength;
            const Z0_line = Z1_line * z0z1Ratio;

            const Z1_reach = Z1_line * z1Coverage;
            const Z2_reach = Z1_line * z2Coverage;
            const Z3_reach = Z1_line * z3Coverage;
            const Z4_reach = Z1_line * z4Coverage;

            const ZTR = CTR / PTR;

            const Z1_sec = Z1_reach * ZTR;
            const Z2_sec = Z2_reach * ZTR;
            const Z3_sec = Z3_reach * ZTR;
            const Z4_sec = Z4_reach * ZTR;

            const z1Rad = z1Angle * Math.PI / 180;
            const z0Rad = z0Angle * Math.PI / 180;

            const Z1_re = Z1_line * Math.cos(z1Rad);
            const Z1_im = Z1_line * Math.sin(z1Rad);
            const Z0_re = Z0_line * Math.cos(z0Rad);
            const Z0_im = Z0_line * Math.sin(z0Rad);

            const Z1_mag_sq = Z1_re*Z1_re + Z1_im*Z1_im;
            const z0_over_z1_re = (Z0_re*Z1_re + Z0_im*Z1_im) / Z1_mag_sq;
            const z0_over_z1_im = (Z0_im*Z1_re - Z0_re*Z1_im) / Z1_mag_sq;

            const k0_re = (z0_over_z1_re - 1) / 3;
            const k0_im = z0_over_z1_im / 3;
            const k0M = Math.sqrt(k0_re*k0_re + k0_im*k0_im);
            const k0A = Math.atan2(k0_im, k0_re) * 180 / Math.PI;

            document.getElementById('z1_reach').textContent = Z1_reach.toFixed(3);
            document.getElementById('z2_reach').textContent = Z2_reach.toFixed(3);
            document.getElementById('z3_reach').textContent = Z3_reach.toFixed(3);
            document.getElementById('z4_reach').textContent = Z4_reach.toFixed(3);

            document.getElementById('Z1MAG').textContent = Z1_sec.toFixed(4);
            document.getElementById('Z1ANG').textContent = z1Angle.toFixed(2);
            document.getElementById('Z2MAG').textContent = Z2_sec.toFixed(4);
            document.getElementById('Z3MAG').textContent = Z3_sec.toFixed(4);
            document.getElementById('Z4MAG').textContent = Z4_sec.toFixed(4);
            document.getElementById('k0M').textContent = k0M.toFixed(4);
            document.getElementById('k0A').textContent = k0A.toFixed(2);

            drawZones(Z1_reach, Z2_reach, Z3_reach, Z4_reach, z1Angle);

            document.getElementById('stepContent').innerHTML = `
<div class="step-section">
<div class="step-title">Line Impedance</div>
<div class="calc-line">Z1_line = ${z1PerMile} × ${lineLength} = ${Z1_line.toFixed(4)} Ω</div>
<div class="calc-line">Z0_line = ${Z1_line.toFixed(4)} × ${z0z1Ratio} = ${Z0_line.toFixed(4)} Ω</div>
</div>
<div class="step-section">
<div class="step-title">Secondary Conversion</div>
<div class="calc-line">ZTR = CTR / PTR = ${CTR} / ${PTR} = ${ZTR.toFixed(6)}</div>
<div class="calc-line">Z1_sec = ${Z1_reach.toFixed(4)} × ${ZTR.toFixed(6)} = ${Z1_sec.toFixed(4)} Ω</div>
</div>
<div class="step-section">
<div class="step-title">Zero Sequence Compensation</div>
<div class="calc-line">k0 = (Z0/Z1 - 1) / 3</div>
<div class="calc-line calc-result">k0 = ${k0M.toFixed(4)} ∠ ${k0A.toFixed(2)}°</div>
</div>
            `;
        }

        function drawZones(Z1, Z2, Z3, Z4, angle) {
            const canvas = document.getElementById('zoneCanvas');
            const ctx = canvas.getContext('2d');
            const w = canvas.width, h = canvas.height;
            const cx = 70, cy = h / 2;

            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, w, h);

            const maxZ = Math.max(Z1, Z2, Z3, Z4);
            const scale = (w - 100) / maxZ;

            ctx.strokeStyle = '#1d1d1f';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(cx, 20); ctx.lineTo(cx, h - 20);
            ctx.moveTo(20, cy); ctx.lineTo(w - 20, cy);
            ctx.stroke();

            ctx.fillStyle = '#86868b';
            ctx.font = '11px -apple-system, sans-serif';
            ctx.fillText('R (Ω)', w - 40, cy - 10);
            ctx.fillText('X (Ω)', cx + 10, 25);

            const angRad = angle * Math.PI / 180;

            function drawMhoCircle(reach, color, label, dashed = false) {
                const centerR = (reach / 2) * Math.cos(angRad);
                const centerX = (reach / 2) * Math.sin(angRad);
                const radius = reach / 2;

                const cpx = cx + centerR * scale;
                const cpy = cy - centerX * scale;
                const rpx = radius * scale;

                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                if (dashed) ctx.setLineDash([5, 5]);
                else ctx.setLineDash([]);

                ctx.beginPath();
                ctx.arc(cpx, cpy, rpx, 0, 2 * Math.PI);
                ctx.stroke();
                ctx.setLineDash([]);

                const reachR = reach * Math.cos(angRad);
                const reachX = reach * Math.sin(angRad);
                ctx.fillStyle = color;
                ctx.font = 'bold 11px -apple-system, sans-serif';
                ctx.fillText(label, cx + reachR * scale + 5, cy - reachX * scale - 5);
            }

            drawMhoCircle(Z3, '#ffd60a', 'Z3', true);
            drawMhoCircle(Z2, '#30d158', 'Z2');
            drawMhoCircle(Z1, '#0a84ff', 'Z1');

            if (Z4 > 0) {
                const centerR = -(Z4 / 2) * Math.cos(angRad);
                const centerX = -(Z4 / 2) * Math.sin(angRad);
                const radius = Z4 / 2;

                ctx.strokeStyle = '#af52de';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.arc(cx + centerR * scale, cy - centerX * scale, radius * scale, 0, 2 * Math.PI);
                ctx.stroke();
                ctx.setLineDash([]);

                ctx.fillStyle = '#af52de';
                ctx.fillText('Z4', cx - Z4 * Math.cos(angRad) * scale - 20, cy + Z4 * Math.sin(angRad) * scale);
            }

            ctx.strokeStyle = '#ffd60a';
            ctx.lineWidth = 1;
            ctx.setLineDash([3, 3]);
            ctx.beginPath();
            ctx.moveTo(cx, cy);
            ctx.lineTo(cx + Z3 * Math.cos(angRad) * scale, cy - Z3 * Math.sin(angRad) * scale);
            ctx.stroke();
            ctx.setLineDash([]);

            ctx.fillStyle = '#48484a';
            ctx.fillText(angle + '°', cx + 30, cy - 15);
        }

        document.querySelectorAll('input').forEach(el => {
            el.addEventListener('input', calculate);
        });

        document.getElementById('stepToggle').addEventListener('click', () => {
            document.getElementById('stepContent').classList.toggle('open');
        });

        calculate();
    </script>
</body>
</html>
