<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synchroscope Trainer</title>
    <link rel="stylesheet" href="tokens.css">
    <style>
        .container {
            max-width: 800px;
        }

        .scope-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: var(--space-xl);
        }

        #scopeCanvas {
            width: 100%;
            max-width: 400px;
            height: auto;
            aspect-ratio: 1;
        }

        .sync-status {
            width: 100%;
            max-width: 400px;
            text-align: center;
            padding: var(--space-lg);
            border-radius: var(--radius-md);
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: var(--space-lg);
            transition: all var(--transition-normal);
        }

        .sync-status.synced {
            background: rgba(48, 209, 88, 0.15);
            color: var(--success);
            box-shadow: 0 0 30px rgba(48, 209, 88, 0.2);
        }

        .sync-status.not-synced {
            background: rgba(255, 69, 58, 0.1);
            color: var(--error);
        }

        .status-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
        }

        .status-item {
            text-align: center;
            padding: var(--space-lg);
            background: var(--bg-subtle);
            border-radius: var(--radius-sm);
        }

        .status-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: var(--space-sm);
        }

        .status-value {
            font-size: 1.5rem;
            font-weight: 600;
            font-family: var(--font-mono);
        }

        .status-value.ok { color: var(--success); }
        .status-value.warning { color: var(--warning); }
        .status-value.error { color: var(--error); }

        .controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-xl);
        }

        .control-section {
            padding: var(--space-lg);
            background: var(--bg-subtle);
            border-radius: var(--radius-md);
        }

        .control-section h3 {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: var(--space-lg);
            text-align: center;
        }

        .control-section.bus h3 { color: var(--phase-a); }
        .control-section.gen h3 { color: var(--phase-c); }

        .slider-group {
            margin-bottom: var(--space-lg);
        }

        .slider-group:last-child {
            margin-bottom: 0;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--space-sm);
            font-size: 0.875rem;
        }

        .slider-value {
            font-family: var(--font-mono);
            color: var(--text);
        }

        .waveform-container {
            margin-top: var(--space-xl);
        }

        #waveCanvas {
            width: 100%;
            height: 200px;
            border-radius: var(--radius-md);
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: var(--space-lg);
            margin-top: var(--space-md);
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .legend-dot {
            width: 12px;
            height: 3px;
            border-radius: 2px;
        }

        .guidelines {
            margin-top: var(--space-xl);
            padding: var(--space-lg);
            background: var(--bg-subtle);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.8;
        }

        .guidelines h4 {
            color: var(--text);
            font-size: 0.875rem;
            margin-bottom: var(--space-md);
        }

        @media (max-width: 600px) {
            .controls-grid {
                grid-template-columns: 1fr;
            }

            .status-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <a href="/random/" class="header-back">← Relay Tools</a>
            <span class="header-title">Synchroscope</span>
        </header>

        <h1>Synchroscope</h1>
        <p class="tagline">Practice generator synchronization timing</p>

        <div class="scope-container">
            <canvas id="scopeCanvas" width="400" height="400"></canvas>
            <div class="sync-status not-synced" id="syncStatus">
                NOT IN SYNC
            </div>
        </div>

        <div class="status-row">
            <div class="status-item">
                <div class="status-label">Slip Frequency</div>
                <div class="status-value" id="slipFreq">0.00 Hz</div>
            </div>
            <div class="status-item">
                <div class="status-label">Phase Angle</div>
                <div class="status-value" id="phaseAngle">0°</div>
            </div>
            <div class="status-item">
                <div class="status-label">Voltage Difference</div>
                <div class="status-value" id="voltDiff">0%</div>
            </div>
        </div>

        <div class="controls-grid">
            <div class="control-section bus">
                <h3>Bus (Running)</h3>
                <div class="slider-group">
                    <div class="slider-header">
                        <span>Voltage</span>
                        <span class="slider-value"><span id="mag1Value">115</span> kV</span>
                    </div>
                    <input type="range" id="mag1" min="100" max="130" value="115">
                </div>
                <div class="slider-group">
                    <div class="slider-header">
                        <span>Frequency</span>
                        <span class="slider-value"><span id="freq1Value">60.00</span> Hz</span>
                    </div>
                    <input type="range" id="freq1" min="59" max="61" step="0.01" value="60">
                </div>
            </div>

            <div class="control-section gen">
                <h3>Generator (Incoming)</h3>
                <div class="slider-group">
                    <div class="slider-header">
                        <span>Voltage</span>
                        <span class="slider-value"><span id="mag2Value">115</span> kV</span>
                    </div>
                    <input type="range" id="mag2" min="100" max="130" value="115">
                </div>
                <div class="slider-group">
                    <div class="slider-header">
                        <span>Frequency</span>
                        <span class="slider-value"><span id="freq2Value">60.00</span> Hz</span>
                    </div>
                    <input type="range" id="freq2" min="59" max="61" step="0.01" value="60">
                </div>
            </div>
        </div>

        <div class="waveform-container">
            <canvas id="waveCanvas"></canvas>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-dot" style="background: var(--phase-a)"></div>
                    Bus
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: var(--phase-c)"></div>
                    Generator
                </div>
            </div>
        </div>

        <div class="guidelines">
            <h4>Synchronizing Criteria</h4>
            Slip Frequency: < 0.067 Hz (pointer completes rotation in > 15 seconds)<br>
            Phase Angle: Within ±10° of 12 o'clock<br>
            Voltage Difference: Within ±5%<br><br>
            <strong>Tip:</strong> Adjust generator frequency to rotate slowly clockwise. Close breaker just before reaching 12 o'clock to account for closing time.
        </div>
    </div>

    <script>
        const scopeCanvas = document.getElementById('scopeCanvas');
        const scopeCtx = scopeCanvas.getContext('2d');
        const waveCanvas = document.getElementById('waveCanvas');
        const waveCtx = waveCanvas.getContext('2d');

        // Set canvas size
        function resizeWaveCanvas() {
            const rect = waveCanvas.getBoundingClientRect();
            waveCanvas.width = rect.width * window.devicePixelRatio;
            waveCanvas.height = 200 * window.devicePixelRatio;
            waveCtx.scale(window.devicePixelRatio, window.devicePixelRatio);
        }
        resizeWaveCanvas();
        window.addEventListener('resize', resizeWaveCanvas);

        const centerX = scopeCanvas.width / 2;
        const centerY = scopeCanvas.height / 2;
        const radius = 140;

        let mag1 = 115, freq1 = 60, mag2 = 115, freq2 = 60;

        // Input handlers
        document.getElementById('mag1').addEventListener('input', e => {
            mag1 = parseFloat(e.target.value);
            document.getElementById('mag1Value').textContent = mag1;
        });
        document.getElementById('freq1').addEventListener('input', e => {
            freq1 = parseFloat(e.target.value);
            document.getElementById('freq1Value').textContent = freq1.toFixed(2);
        });
        document.getElementById('mag2').addEventListener('input', e => {
            mag2 = parseFloat(e.target.value);
            document.getElementById('mag2Value').textContent = mag2;
        });
        document.getElementById('freq2').addEventListener('input', e => {
            freq2 = parseFloat(e.target.value);
            document.getElementById('freq2Value').textContent = freq2.toFixed(2);
        });

        let startTime = null;

        function draw(timestamp) {
            if (!startTime) startTime = timestamp;
            const time = (timestamp - startTime) / 1000;

            // Clear
            scopeCtx.fillStyle = '#000';
            scopeCtx.fillRect(0, 0, scopeCanvas.width, scopeCanvas.height);

            // Outer ring gradient
            const gradient = scopeCtx.createRadialGradient(centerX, centerY, radius - 10, centerX, centerY, radius + 10);
            gradient.addColorStop(0, '#1d1d1f');
            gradient.addColorStop(1, '#2a2a2c');
            scopeCtx.beginPath();
            scopeCtx.arc(centerX, centerY, radius + 5, 0, 2 * Math.PI);
            scopeCtx.fillStyle = gradient;
            scopeCtx.fill();

            // Inner circle
            scopeCtx.beginPath();
            scopeCtx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            scopeCtx.fillStyle = '#000';
            scopeCtx.fill();
            scopeCtx.strokeStyle = '#333';
            scopeCtx.lineWidth = 1;
            scopeCtx.stroke();

            // Tick marks
            scopeCtx.font = '11px -apple-system, sans-serif';
            scopeCtx.fillStyle = '#86868b';
            scopeCtx.textAlign = 'center';
            scopeCtx.textBaseline = 'middle';

            for (let deg = -180; deg <= 150; deg += 30) {
                const rad = (90 - deg) * Math.PI / 180;
                const tickLength = deg === 0 ? 20 : 10;

                const innerX = centerX + (radius - tickLength) * Math.cos(rad);
                const innerY = centerY - (radius - tickLength) * Math.sin(rad);
                const outerX = centerX + radius * Math.cos(rad);
                const outerY = centerY - radius * Math.sin(rad);

                scopeCtx.beginPath();
                scopeCtx.moveTo(innerX, innerY);
                scopeCtx.lineTo(outerX, outerY);
                scopeCtx.strokeStyle = deg === 0 ? '#30d158' : '#48484a';
                scopeCtx.lineWidth = deg === 0 ? 3 : 1;
                scopeCtx.stroke();

                // Label
                const labelX = centerX + (radius + 20) * Math.cos(rad);
                const labelY = centerY - (radius + 20) * Math.sin(rad);
                scopeCtx.fillText(deg + '°', labelX, labelY);
            }

            // SLOW/FAST labels
            scopeCtx.font = 'bold 12px -apple-system, sans-serif';
            scopeCtx.fillStyle = '#86868b';
            scopeCtx.fillText('SLOW', centerX - 60, centerY);
            scopeCtx.fillText('FAST', centerX + 60, centerY);

            // Calculate angle
            const slipFreq = freq2 - freq1;
            const thetaRel = 2 * Math.PI * slipFreq * time;
            const displayAngle = thetaRel * 180 / Math.PI;
            const normalizedAngle = ((displayAngle % 360) + 360) % 360;
            const angleForDisplay = normalizedAngle > 180 ? normalizedAngle - 360 : normalizedAngle;

            // Pointer
            const pointerAngle = Math.PI / 2 - thetaRel;
            const pointerX = centerX + (radius - 25) * Math.cos(pointerAngle);
            const pointerY = centerY - (radius - 25) * Math.sin(pointerAngle);

            scopeCtx.strokeStyle = '#fff';
            scopeCtx.lineWidth = 3;
            scopeCtx.lineCap = 'round';
            scopeCtx.beginPath();
            scopeCtx.moveTo(centerX, centerY);
            scopeCtx.lineTo(pointerX, pointerY);
            scopeCtx.stroke();

            // Pointer tip
            scopeCtx.fillStyle = '#fff';
            scopeCtx.beginPath();
            scopeCtx.moveTo(pointerX, pointerY);
            scopeCtx.lineTo(
                pointerX - 12 * Math.cos(pointerAngle - 0.3),
                pointerY + 12 * Math.sin(pointerAngle - 0.3)
            );
            scopeCtx.lineTo(
                pointerX - 12 * Math.cos(pointerAngle + 0.3),
                pointerY + 12 * Math.sin(pointerAngle + 0.3)
            );
            scopeCtx.closePath();
            scopeCtx.fill();

            // Center dot
            scopeCtx.beginPath();
            scopeCtx.arc(centerX, centerY, 6, 0, 2 * Math.PI);
            scopeCtx.fillStyle = '#fff';
            scopeCtx.fill();

            // Draw waveforms
            drawWaveforms(time);

            // Update status
            const slipFreqAbs = Math.abs(slipFreq);
            const voltDiff = Math.abs(mag2 - mag1) / mag1 * 100;
            const angleAbs = Math.abs(angleForDisplay);

            document.getElementById('slipFreq').textContent = slipFreqAbs.toFixed(3) + ' Hz';
            document.getElementById('slipFreq').className = 'status-value ' +
                (slipFreqAbs < 0.067 ? 'ok' : slipFreqAbs < 0.2 ? 'warning' : 'error');

            document.getElementById('phaseAngle').textContent = angleForDisplay.toFixed(1) + '°';
            document.getElementById('phaseAngle').className = 'status-value ' +
                (angleAbs < 10 ? 'ok' : angleAbs < 30 ? 'warning' : 'error');

            document.getElementById('voltDiff').textContent = voltDiff.toFixed(1) + '%';
            document.getElementById('voltDiff').className = 'status-value ' +
                (voltDiff < 5 ? 'ok' : voltDiff < 10 ? 'warning' : 'error');

            // Sync status
            const inSync = slipFreqAbs < 0.067 && angleAbs < 10 && voltDiff < 5;
            const statusEl = document.getElementById('syncStatus');
            statusEl.textContent = inSync ? 'IN SYNC — OK TO CLOSE' : 'NOT IN SYNC';
            statusEl.className = 'sync-status ' + (inSync ? 'synced' : 'not-synced');

            requestAnimationFrame(draw);
        }

        function drawWaveforms(currentTime) {
            const w = waveCanvas.width / window.devicePixelRatio;
            const h = 200;

            waveCtx.fillStyle = '#000';
            waveCtx.fillRect(0, 0, w, h);

            // Grid
            waveCtx.strokeStyle = '#1d1d1f';
            waveCtx.lineWidth = 1;
            for (let i = 0; i < w; i += 50) {
                waveCtx.beginPath();
                waveCtx.moveTo(i, 0);
                waveCtx.lineTo(i, h);
                waveCtx.stroke();
            }

            // Zero line
            waveCtx.strokeStyle = '#333';
            waveCtx.beginPath();
            waveCtx.moveTo(0, h / 2);
            waveCtx.lineTo(w, h / 2);
            waveCtx.stroke();

            const samples = w;
            const dt = 0.1 / samples;
            const yScale = 70 / 130;

            // Bus (red)
            waveCtx.beginPath();
            waveCtx.strokeStyle = '#ff453a';
            waveCtx.lineWidth = 2;
            for (let i = 0; i < samples; i++) {
                const t = currentTime + i * dt;
                const v = mag1 * Math.sin(2 * Math.PI * freq1 * t);
                const y = h / 2 - v * yScale;
                if (i === 0) waveCtx.moveTo(i, y);
                else waveCtx.lineTo(i, y);
            }
            waveCtx.stroke();

            // Generator (blue)
            waveCtx.beginPath();
            waveCtx.strokeStyle = '#0a84ff';
            for (let i = 0; i < samples; i++) {
                const t = currentTime + i * dt;
                const v = mag2 * Math.sin(2 * Math.PI * freq2 * t);
                const y = h / 2 - v * yScale;
                if (i === 0) waveCtx.moveTo(i, y);
                else waveCtx.lineTo(i, y);
            }
            waveCtx.stroke();
        }

        requestAnimationFrame(draw);
    </script>
</body>
</html>
