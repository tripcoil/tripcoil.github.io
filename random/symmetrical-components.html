<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Symmetrical Components Calculator</title>
    <link rel="stylesheet" href="tokens.css">
    <style>
        .mode-toggle {
            display: flex;
            justify-content: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-xl);
        }

        .mode-btn {
            padding: var(--space-sm) var(--space-lg);
            background: transparent;
            border: 1px solid var(--bg-hover);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .mode-btn:hover { border-color: var(--text-secondary); }
        .mode-btn.active {
            background: var(--bg-hover);
            border-color: var(--text);
            color: var(--text);
        }

        .calc-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-lg);
        }

        .phasor-input {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-sm);
            margin-bottom: var(--space-md);
        }

        .phasor-label {
            grid-column: 1 / -1;
            font-weight: 600;
            margin-bottom: var(--space-xs);
        }

        .results-section {
            padding: var(--space-lg);
            background: var(--bg-subtle);
            border-radius: var(--radius-md);
        }

        .result-row {
            display: grid;
            grid-template-columns: 60px 1fr 1fr;
            gap: var(--space-md);
            padding: var(--space-md) 0;
            border-bottom: 1px solid var(--bg-hover);
            align-items: center;
        }

        .result-row:last-child { border-bottom: none; }

        .result-row .label {
            font-weight: 600;
        }

        .result-row .value {
            font-family: var(--font-mono);
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .canvas-container {
            margin-top: var(--space-lg);
            display: flex;
            justify-content: center;
        }

        .legend {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: var(--space-md);
            margin-top: var(--space-md);
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .legend-color {
            width: 16px;
            height: 3px;
            border-radius: 2px;
        }

        @media (max-width: 700px) {
            .calc-grid {
                grid-template-columns: 1fr;
            }
            .result-row {
                grid-template-columns: 1fr;
                gap: var(--space-xs);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <a href="/random/" class="header-back">← Relay Tools</a>
            <span class="header-title">Sequence Components</span>
        </header>

        <h1>Symmetrical Components</h1>
        <p class="tagline">Convert between phase and sequence quantities</p>

        <div class="mode-toggle">
            <button class="mode-btn active" data-mode="abc">ABC → 012</button>
            <button class="mode-btn" data-mode="seq">012 → ABC</button>
        </div>

        <div class="calc-grid">
            <div class="results-section" id="inputSection">
                <!-- Populated by JS -->
            </div>

            <div class="results-section" id="outputSection">
                <!-- Populated by JS -->
            </div>
        </div>

        <div class="canvas-container">
            <canvas id="phasorCanvas" width="400" height="400"></canvas>
        </div>
        <div class="legend">
            <div class="legend-item"><div class="legend-color" style="background: var(--phase-a)"></div>Phase A</div>
            <div class="legend-item"><div class="legend-color" style="background: var(--phase-b)"></div>Phase B</div>
            <div class="legend-item"><div class="legend-color" style="background: var(--phase-c)"></div>Phase C</div>
            <div class="legend-item"><div class="legend-color" style="background: var(--seq-pos); opacity: 0.7"></div>V₁ (pos)</div>
            <div class="legend-item"><div class="legend-color" style="background: var(--seq-neg); opacity: 0.7"></div>V₂ (neg)</div>
            <div class="legend-item"><div class="legend-color" style="background: var(--seq-zero); opacity: 0.7"></div>V₀ (zero)</div>
        </div>

        <div class="drawer-trigger" id="stepToggle">See formulas →</div>
        <div class="step-content" id="stepContent">
<div class="step-section">
<div class="step-title">Transformation Matrices</div>
<pre>
The operator a = 1∠120° = -0.5 + j0.866

ABC to Sequence:
┌     ┐   ┌           ┐   ┌    ┐
│ V₀  │   │ 1   1   1 │   │ Vₐ │
│ V₁  │ = │ 1   a   a²│ × │ Vᵦ │  × (1/3)
│ V₂  │   │ 1   a²  a │   │ Vᶜ │
└     ┘   └           ┘   └    ┘

Sequence to ABC:
┌    ┐   ┌           ┐   ┌    ┐
│ Vₐ │   │ 1   1   1 │   │ V₀ │
│ Vᵦ │ = │ 1   a²  a │ × │ V₁ │
│ Vᶜ │   │ 1   a   a²│   │ V₂ │
└    ┘   └           ┘   └    ┘
</pre>
</div>
        </div>
    </div>

    <script>
        let mode = 'abc';

        const a_re = -0.5;
        const a_im = Math.sqrt(3)/2;
        const a2_re = -0.5;
        const a2_im = -Math.sqrt(3)/2;

        function polarToRect(mag, angDeg) {
            const angRad = angDeg * Math.PI / 180;
            return { re: mag * Math.cos(angRad), im: mag * Math.sin(angRad) };
        }

        function rectToPolar(re, im) {
            const mag = Math.sqrt(re*re + im*im);
            const ang = Math.atan2(im, re) * 180 / Math.PI;
            return { mag, ang };
        }

        function complexMult(a, b) {
            return { re: a.re*b.re - a.im*b.im, im: a.re*b.im + a.im*b.re };
        }

        function complexAdd(a, b) {
            return { re: a.re + b.re, im: a.im + b.im };
        }

        function formatPolar(c) {
            const p = rectToPolar(c.re, c.im);
            return `${p.mag.toFixed(3)}∠${p.ang.toFixed(1)}°`;
        }

        function formatRect(c) {
            const sign = c.im >= 0 ? '+' : '-';
            return `${c.re.toFixed(3)} ${sign} j${Math.abs(c.im).toFixed(3)}`;
        }

        function renderInputs() {
            const section = document.getElementById('inputSection');
            if (mode === 'abc') {
                section.innerHTML = `
                    <h2 style="margin-bottom: var(--space-lg); font-size: 1rem; color: var(--text-secondary);">Phase Quantities</h2>
                    <div class="phasor-input">
                        <span class="phasor-label phase-a">Va</span>
                        <input type="text" id="in1" value="100∠0" placeholder="mag∠angle">
                    </div>
                    <div class="phasor-input">
                        <span class="phasor-label phase-b">Vb</span>
                        <input type="text" id="in2" value="100∠-120" placeholder="mag∠angle">
                    </div>
                    <div class="phasor-input">
                        <span class="phasor-label phase-c">Vc</span>
                        <input type="text" id="in3" value="100∠120" placeholder="mag∠angle">
                    </div>
                `;
            } else {
                section.innerHTML = `
                    <h2 style="margin-bottom: var(--space-lg); font-size: 1rem; color: var(--text-secondary);">Sequence Components</h2>
                    <div class="phasor-input">
                        <span class="phasor-label seq-pos">V₁</span>
                        <input type="text" id="in1" value="100∠0" placeholder="mag∠angle">
                    </div>
                    <div class="phasor-input">
                        <span class="phasor-label seq-neg">V₂</span>
                        <input type="text" id="in2" value="0∠0" placeholder="mag∠angle">
                    </div>
                    <div class="phasor-input">
                        <span class="phasor-label seq-zero">V₀</span>
                        <input type="text" id="in3" value="0∠0" placeholder="mag∠angle">
                    </div>
                `;
            }
            document.querySelectorAll('#inputSection input').forEach(inp => {
                inp.addEventListener('input', calculate);
            });
            calculate();
        }

        function parsePolar(str) {
            if (!str) return { re: 0, im: 0 };
            str = str.trim().replace(/</g, '∠').replace(/\s+/g, '∠');
            const match = str.match(/^([+-]?[\d.]+)∠([+-]?[\d.]+)$/);
            if (match) {
                const mag = parseFloat(match[1]);
                const ang = parseFloat(match[2]) * Math.PI / 180;
                return { re: mag * Math.cos(ang), im: mag * Math.sin(ang) };
            }
            const num = parseFloat(str);
            if (!isNaN(num)) return { re: num, im: 0 };
            return { re: 0, im: 0 };
        }

        function calculate() {
            const in1 = parsePolar(document.getElementById('in1').value);
            const in2 = parsePolar(document.getElementById('in2').value);
            const in3 = parsePolar(document.getElementById('in3').value);

            let Va, Vb, Vc, V0, V1, V2;
            let labels, colors, results;
            const a = { re: a_re, im: a_im };
            const a2 = { re: a2_re, im: a2_im };

            if (mode === 'abc') {
                Va = in1; Vb = in2; Vc = in3;

                V0 = { re: (Va.re + Vb.re + Vc.re) / 3, im: (Va.im + Vb.im + Vc.im) / 3 };

                const aVb = complexMult(a, Vb);
                const a2Vc = complexMult(a2, Vc);
                V1 = { re: (Va.re + aVb.re + a2Vc.re) / 3, im: (Va.im + aVb.im + a2Vc.im) / 3 };

                const a2Vb = complexMult(a2, Vb);
                const aVc = complexMult(a, Vc);
                V2 = { re: (Va.re + a2Vb.re + aVc.re) / 3, im: (Va.im + a2Vb.im + aVc.im) / 3 };

                results = [V1, V2, V0];
                labels = ['V₁', 'V₂', 'V₀'];
                colors = ['seq-pos', 'seq-neg', 'seq-zero'];
            } else {
                V1 = in1; V2 = in2; V0 = in3;

                Va = complexAdd(complexAdd(V0, V1), V2);
                Vb = complexAdd(complexAdd(V0, complexMult(a2, V1)), complexMult(a, V2));
                Vc = complexAdd(complexAdd(V0, complexMult(a, V1)), complexMult(a2, V2));

                results = [Va, Vb, Vc];
                labels = ['Va', 'Vb', 'Vc'];
                colors = ['phase-a', 'phase-b', 'phase-c'];
            }

            const output = document.getElementById('outputSection');
            output.innerHTML = `
                <h2 style="margin-bottom: var(--space-lg); font-size: 1rem; color: var(--text-secondary);">
                    ${mode === 'abc' ? 'Sequence Components' : 'Phase Quantities'}
                </h2>
                ${results.map((r, i) => `
                    <div class="result-row">
                        <span class="label ${colors[i]}">${labels[i]}</span>
                        <span class="value">${formatPolar(r)}</span>
                        <span class="value">${formatRect(r)}</span>
                    </div>
                `).join('')}
            `;

            drawPhasors(Va, Vb, Vc, V0, V1, V2);
        }

        function drawPhasors(Va, Vb, Vc, V0, V1, V2) {
            const canvas = document.getElementById('phasorCanvas');
            const ctx = canvas.getContext('2d');
            const w = canvas.width, h = canvas.height;
            const cx = w/2, cy = h/2;

            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, w, h);

            const mags = [Va, Vb, Vc, V0, V1, V2].map(v => Math.sqrt(v.re*v.re + v.im*v.im));
            const maxMag = Math.max(...mags, 1);
            const scale = (Math.min(w, h) / 2 - 40) / maxMag;

            ctx.strokeStyle = '#1d1d1f';
            ctx.lineWidth = 0.5;
            for (let r = scale * maxMag / 4; r <= scale * maxMag; r += scale * maxMag / 4) {
                ctx.beginPath();
                ctx.arc(cx, cy, r, 0, 2 * Math.PI);
                ctx.stroke();
            }

            ctx.strokeStyle = '#1d1d1f';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(0, cy); ctx.lineTo(w, cy);
            ctx.moveTo(cx, 0); ctx.lineTo(cx, h);
            ctx.stroke();

            function drawArrow(v, color, dashed = false) {
                const x = cx + v.re * scale;
                const y = cy - v.im * scale;
                const ang = Math.atan2(-v.im, v.re);
                const headLen = 10;
                const mag = Math.sqrt(v.re*v.re + v.im*v.im);
                if (mag < 0.01) return;

                ctx.strokeStyle = color;
                ctx.fillStyle = color;
                ctx.lineWidth = 2;
                if (dashed) ctx.setLineDash([5, 5]);
                else ctx.setLineDash([]);

                ctx.beginPath();
                ctx.moveTo(cx, cy);
                ctx.lineTo(x, y);
                ctx.stroke();

                ctx.beginPath();
                ctx.moveTo(x, y);
                ctx.lineTo(x - headLen * Math.cos(ang - Math.PI/6), y + headLen * Math.sin(ang - Math.PI/6));
                ctx.lineTo(x - headLen * Math.cos(ang + Math.PI/6), y + headLen * Math.sin(ang + Math.PI/6));
                ctx.closePath();
                ctx.fill();
                ctx.setLineDash([]);
            }

            drawArrow(Va, '#ff453a');
            drawArrow(Vb, '#30d158');
            drawArrow(Vc, '#0a84ff');

            drawArrow(V1, '#30d158', true);
            drawArrow(V2, '#ff453a', true);
            drawArrow(V0, '#0a84ff', true);
        }

        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                mode = btn.dataset.mode;
                renderInputs();
            });
        });

        document.getElementById('stepToggle').addEventListener('click', () => {
            document.getElementById('stepContent').classList.toggle('open');
        });

        renderInputs();
    </script>
</body>
</html>
