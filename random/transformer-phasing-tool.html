<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transformer Phasing Tool</title>
    <link rel="stylesheet" href="tokens.css">
    <style>
        .config-section {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-md);
            padding: var(--space-lg);
            background: var(--bg-subtle);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-xl);
        }

        .canvas-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }

        .canvas-section {
            text-align: center;
            padding: var(--space-lg);
            background: var(--bg-subtle);
            border-radius: var(--radius-md);
        }

        .canvas-section h3 {
            margin-bottom: var(--space-md);
            color: var(--text-secondary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        canvas {
            background: var(--bg);
            border-radius: var(--radius-sm);
        }

        .vector-group {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text);
            text-align: center;
            padding: var(--space-xl);
            background: var(--bg-subtle);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-xl);
        }

        .vector-group small {
            display: block;
            font-size: 0.875rem;
            color: var(--text-muted);
            font-weight: 400;
            margin-top: var(--space-sm);
        }

        .phase-table {
            background: var(--bg-subtle);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .phase-table h2 {
            padding: var(--space-lg);
            margin: 0;
            font-size: 1rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--bg-hover);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: var(--space-md);
            text-align: left;
            border-bottom: 1px solid var(--bg-hover);
        }

        th {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        td {
            font-family: var(--font-mono);
        }

        .phase-a { color: var(--phase-a); }
        .phase-b { color: var(--phase-b); }
        .phase-c { color: var(--phase-c); }

        @media (max-width: 768px) {
            .config-section {
                grid-template-columns: 1fr;
            }
            .canvas-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <a href="/random/" class="header-back">← Relay Tools</a>
            <span class="header-title">Transformer Phasing</span>
        </header>

        <h1>Transformer Phasing Tool</h1>
        <p class="tagline">Visualize transformer vector groups and phase relationships</p>

        <div class="config-section">
            <div class="input-group">
                <label for="type">Transformer Type</label>
                <select id="type">
                    <option value="Y-Y">Wye-Wye (Y-Y)</option>
                    <option value="D-D">Delta-Delta (D-D)</option>
                    <option value="D-Y" selected>Delta-Wye (D-Y)</option>
                    <option value="Y-D">Wye-Delta (Y-D)</option>
                </select>
            </div>
            <div class="input-group">
                <label for="rotation">System Phase Rotation</label>
                <select id="rotation">
                    <option value="ABC">ABC (Positive Sequence)</option>
                    <option value="ACB">ACB (Negative Sequence)</option>
                </select>
            </div>
            <div class="input-group">
                <label for="connection">High Side Connection (H1-H2-H3)</label>
                <select id="connection">
                    <option value="ABC">A-B-C</option>
                    <option value="ACB">A-C-B</option>
                    <option value="BAC">B-A-C</option>
                    <option value="BCA">B-C-A</option>
                    <option value="CAB">C-A-B</option>
                    <option value="CBA">C-B-A</option>
                </select>
            </div>
        </div>

        <div class="canvas-grid">
            <div class="canvas-section">
                <h3>High Side Phasors</h3>
                <canvas id="highCanvas" width="350" height="350"></canvas>
            </div>
            <div class="canvas-section">
                <h3>Low Side Phasors</h3>
                <canvas id="lowCanvas" width="350" height="350"></canvas>
            </div>
        </div>

        <div class="vector-group" id="vectorGroup">Dy1</div>

        <div class="phase-table">
            <h2>Phase Relationships</h2>
            <table>
                <thead>
                    <tr>
                        <th>High Side Terminal</th>
                        <th>Connected Phase</th>
                        <th>High Side Angle</th>
                        <th>Low Side Terminal</th>
                        <th>Low Side Angle</th>
                    </tr>
                </thead>
                <tbody id="phaseTable"></tbody>
            </table>
        </div>

        <div class="drawer-trigger" id="stepToggle">See explanation →</div>
        <div class="step-content" id="stepContent">
            <div class="show-work-content" id="explanation"></div>
        </div>
    </div>

    <script>
        const PHASE_COLORS = {
            'A': '#ff453a',
            'B': '#30d158',
            'C': '#0a84ff'
        };

        function drawPhasors(canvas, angles, labels, bushing_labels) {
            const ctx = canvas.getContext('2d');
            const cx = canvas.width / 2;
            const cy = canvas.height / 2;
            const radius = 120;

            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.strokeStyle = '#3a3a3c';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.arc(cx, cy, radius, 0, 2 * Math.PI);
            ctx.stroke();

            ctx.strokeStyle = '#1d1d1f';
            ctx.beginPath();
            ctx.moveTo(cx - radius - 20, cy);
            ctx.lineTo(cx + radius + 20, cy);
            ctx.moveTo(cx, cy - radius - 20);
            ctx.lineTo(cx, cy + radius + 20);
            ctx.stroke();

            for (let i = 0; i < 3; i++) {
                const angDeg = angles[i];
                const angRad = angDeg * Math.PI / 180;
                const endX = cx + radius * Math.cos(angRad);
                const endY = cy - radius * Math.sin(angRad);
                const phase = labels[i];
                const color = PHASE_COLORS[phase] || '#888';

                ctx.strokeStyle = color;
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(cx, cy);
                ctx.lineTo(endX, endY);
                ctx.stroke();

                const headlen = 12;
                const dx = endX - cx;
                const dy = endY - cy;
                const angle = Math.atan2(dy, dx);
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.moveTo(endX, endY);
                ctx.lineTo(endX - headlen * Math.cos(angle - Math.PI/6), endY - headlen * Math.sin(angle - Math.PI/6));
                ctx.lineTo(endX - headlen * Math.cos(angle + Math.PI/6), endY - headlen * Math.sin(angle + Math.PI/6));
                ctx.closePath();
                ctx.fill();

                const labelX = cx + (radius + 35) * Math.cos(angRad);
                const labelY = cy - (radius + 35) * Math.sin(angRad);
                ctx.fillStyle = '#fff';
                ctx.font = '14px -apple-system, sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(bushing_labels[i] + '-' + phase, labelX, labelY);
            }

            ctx.fillStyle = '#86868b';
            ctx.font = '11px -apple-system, sans-serif';
            ctx.fillText('0°/12', cx, cy - radius - 30);
        }

        function updatePlots() {
            const type = document.getElementById('type').value;
            const rotation = document.getElementById('rotation').value;
            const conn = document.getElementById('connection').value;

            const positiveConns = ['ABC', 'BCA', 'CAB'];
            let isPositiveSequence = positiveConns.includes(conn);
            if (rotation === 'ACB') {
                isPositiveSequence = !isPositiveSequence;
            }

            let system = {};
            if (rotation === 'ABC') {
                system = { 'A': 90, 'B': -30, 'C': 210 };
            } else {
                system = { 'A': 90, 'B': 210, 'C': -30 };
            }

            const phases = conn.split('');
            const highAngles = [system[phases[0]], system[phases[1]], system[phases[2]]];
            const highLabels = phases;
            const highBushings = ['H1', 'H2', 'H3'];

            let shift = 0;
            if (type === 'D-Y') {
                shift = isPositiveSequence ? -30 : 30;
            } else if (type === 'Y-D') {
                shift = isPositiveSequence ? 30 : -30;
            }

            const lowAngles = highAngles.map(a => ((a + shift) % 360 + 360) % 360);
            const lowLabels = phases;
            const lowBushings = ['X1', 'X2', 'X3'];

            let clockHour = Math.round((-shift / 30 + 12) % 12);
            if (clockHour === 0) clockHour = 12;
            if (type === 'Y-Y' || type === 'D-D') clockHour = 0;

            const primarySymbol = type.split('-')[0] === 'D' ? 'D' : 'Y';
            const secondarySymbol = type.split('-')[1] === 'D' ? 'd' : 'y';
            const vectorGroup = primarySymbol + secondarySymbol + clockHour;

            document.getElementById('vectorGroup').innerHTML = vectorGroup +
                '<small>IEEE/ANSI Vector Group Designation</small>';

            drawPhasors(document.getElementById('highCanvas'), highAngles, highLabels, highBushings);
            drawPhasors(document.getElementById('lowCanvas'), lowAngles, lowLabels, lowBushings);

            let tableHTML = '';
            for (let i = 0; i < 3; i++) {
                tableHTML += `<tr>
                    <td>${highBushings[i]}</td>
                    <td class="phase-${phases[i].toLowerCase()}">${phases[i]}</td>
                    <td>${highAngles[i].toFixed(0)}°</td>
                    <td>${lowBushings[i]}</td>
                    <td>${lowAngles[i].toFixed(0)}°</td>
                </tr>`;
            }
            document.getElementById('phaseTable').innerHTML = tableHTML;

            let explanation = `Transformer Type: ${type}
System Rotation: ${rotation} (${rotation === 'ABC' ? 'Positive' : 'Negative'} Sequence)
High Side Connection: ${conn} on H1-H2-H3

`;

            if (type === 'D-Y' || type === 'Y-D') {
                explanation += `Phase Shift: ${Math.abs(shift)}° (${shift < 0 ? 'Low side lags' : 'Low side leads'})

Per IEEE C57.12.00:
- For D-Y transformers with positive sequence, high side leads low side by 30°
- This is equivalent to the low side lagging by 30°
`;
            } else {
                explanation += `No phase shift for ${type} connection
`;
            }

            explanation += `
Vector Group: ${vectorGroup}
- First letter (${primarySymbol}): Primary winding connection
- Second letter (${secondarySymbol.toLowerCase()}): Secondary winding connection
- Number (${clockHour}): Clock hour position of low voltage phasor`;

            document.getElementById('explanation').textContent = explanation;
        }

        document.getElementById('type').addEventListener('change', updatePlots);
        document.getElementById('rotation').addEventListener('change', updatePlots);
        document.getElementById('connection').addEventListener('change', updatePlots);

        document.getElementById('stepToggle').addEventListener('click', () => {
            document.getElementById('stepContent').classList.toggle('open');
        });

        updatePlots();
    </script>
</body>
</html>
