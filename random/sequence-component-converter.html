<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sequence Component Converter</title>
    <link rel="stylesheet" href="tokens.css">
    <style>
        .mode-toggle {
            display: flex;
            justify-content: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-xl);
        }

        .mode-btn {
            padding: var(--space-sm) var(--space-lg);
            background: transparent;
            border: 1px solid var(--bg-hover);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .mode-btn:hover { border-color: var(--text-secondary); }
        .mode-btn.active {
            background: var(--bg-hover);
            border-color: var(--text);
            color: var(--text);
        }

        .input-section {
            margin-bottom: var(--space-xl);
        }

        .phasor-input {
            display: grid;
            grid-template-columns: auto 1fr 1fr;
            gap: var(--space-md);
            align-items: center;
            margin-bottom: var(--space-md);
        }

        .phasor-label {
            font-weight: 600;
            font-size: 1.1rem;
            width: 30px;
        }

        .phasor-label.phase-a { color: var(--phase-a); }
        .phasor-label.phase-b { color: var(--phase-b); }
        .phasor-label.phase-c { color: var(--phase-c); }
        .phasor-label.seq-pos { color: var(--seq-pos); }
        .phasor-label.seq-neg { color: var(--seq-neg); }
        .phasor-label.seq-zero { color: var(--seq-zero); }

        .results-section {
            padding: var(--space-lg);
            background: var(--bg-subtle);
            border-radius: var(--radius-md);
        }

        .result-row {
            display: grid;
            grid-template-columns: auto 1fr 1fr;
            gap: var(--space-md);
            align-items: center;
            padding: var(--space-md) 0;
            border-bottom: 1px solid var(--bg-hover);
        }

        .result-row:last-child { border-bottom: none; }

        .result-polar, .result-rect {
            font-family: var(--font-mono);
            font-size: 0.9rem;
        }

        .result-polar { color: var(--text); }
        .result-rect { color: var(--text-secondary); }

        .canvas-container {
            margin-top: var(--space-xl);
            display: flex;
            justify-content: center;
        }

        #phasorCanvas {
            max-width: 100%;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: var(--space-lg);
            margin-top: var(--space-md);
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .legend-dot {
            width: 12px;
            height: 3px;
            border-radius: 2px;
        }

        @media (max-width: 600px) {
            .phasor-input, .result-row {
                grid-template-columns: 1fr;
                gap: var(--space-sm);
            }
            .phasor-label { width: auto; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <a href="/random/" class="header-back">← Relay Tools</a>
            <span class="header-title">Sequence Components</span>
        </header>

        <h1>Sequence Components</h1>
        <p class="tagline">Convert between phase and sequence components</p>

        <div class="mode-toggle">
            <button class="mode-btn active" data-mode="abc-to-seq">ABC → 012</button>
            <button class="mode-btn" data-mode="seq-to-abc">012 → ABC</button>
        </div>

        <div class="input-section" id="inputSection">
            <!-- Populated by JS -->
        </div>

        <div class="results-section" id="resultsSection">
            <!-- Populated by JS -->
        </div>

        <div class="canvas-container">
            <canvas id="phasorCanvas" width="350" height="350"></canvas>
        </div>
        <div class="legend">
            <div class="legend-item"><div class="legend-dot" style="background: var(--phase-a)"></div>A / +</div>
            <div class="legend-item"><div class="legend-dot" style="background: var(--phase-b)"></div>B / −</div>
            <div class="legend-item"><div class="legend-dot" style="background: var(--phase-c)"></div>C / 0</div>
        </div>

        <div class="drawer-trigger" id="stepToggle">See calculation →</div>
        <div class="step-content" id="stepContent"></div>
    </div>

    <script>
        let mode = 'abc-to-seq';
        const DEG = Math.PI / 180;
        const a = { re: -0.5, im: Math.sqrt(3)/2 };
        const a2 = { re: -0.5, im: -Math.sqrt(3)/2 };

        function parsePolar(str) {
            if (!str) return { re: 0, im: 0 };
            str = str.trim().replace(/</g, '∠').replace(/\s+/g, '∠');
            const match = str.match(/^([+-]?[\d.]+)∠([+-]?[\d.]+)$/);
            if (match) {
                const mag = parseFloat(match[1]);
                const ang = parseFloat(match[2]) * DEG;
                return { re: mag * Math.cos(ang), im: mag * Math.sin(ang) };
            }
            const num = parseFloat(str);
            if (!isNaN(num)) return { re: num, im: 0 };
            return { re: 0, im: 0 };
        }

        function toPolar(c) {
            return { mag: Math.sqrt(c.re*c.re + c.im*c.im), ang: Math.atan2(c.im, c.re) / DEG };
        }

        function formatPolar(c) {
            const p = toPolar(c);
            return `${p.mag.toFixed(3)}∠${p.ang.toFixed(1)}°`;
        }

        function formatRect(c) {
            const sign = c.im >= 0 ? '+' : '-';
            return `${c.re.toFixed(3)} ${sign} j${Math.abs(c.im).toFixed(3)}`;
        }

        function cAdd(a, b) { return { re: a.re + b.re, im: a.im + b.im }; }
        function cMul(a, b) { return { re: a.re*b.re - a.im*b.im, im: a.re*b.im + a.im*b.re }; }
        function cScale(c, s) { return { re: c.re * s, im: c.im * s }; }

        function abcToSeq(Va, Vb, Vc) {
            const V0 = cScale(cAdd(cAdd(Va, Vb), Vc), 1/3);
            const V1 = cScale(cAdd(cAdd(Va, cMul(a, Vb)), cMul(a2, Vc)), 1/3);
            const V2 = cScale(cAdd(cAdd(Va, cMul(a2, Vb)), cMul(a, Vc)), 1/3);
            return { V0, V1, V2 };
        }

        function seqToAbc(V0, V1, V2) {
            const Va = cAdd(cAdd(V0, V1), V2);
            const Vb = cAdd(cAdd(V0, cMul(a2, V1)), cMul(a, V2));
            const Vc = cAdd(cAdd(V0, cMul(a, V1)), cMul(a2, V2));
            return { Va, Vb, Vc };
        }

        function renderInputs() {
            const section = document.getElementById('inputSection');
            if (mode === 'abc-to-seq') {
                section.innerHTML = `
                    <div class="phasor-input">
                        <span class="phasor-label phase-a">Va</span>
                        <input type="text" id="in1_mag" value="277∠0" placeholder="mag∠angle">
                        <input type="text" id="in1_alt" value="" placeholder="or rect" style="display:none">
                    </div>
                    <div class="phasor-input">
                        <span class="phasor-label phase-b">Vb</span>
                        <input type="text" id="in2_mag" value="277∠-120" placeholder="mag∠angle">
                        <input type="text" id="in2_alt" value="" placeholder="or rect" style="display:none">
                    </div>
                    <div class="phasor-input">
                        <span class="phasor-label phase-c">Vc</span>
                        <input type="text" id="in3_mag" value="277∠120" placeholder="mag∠angle">
                        <input type="text" id="in3_alt" value="" placeholder="or rect" style="display:none">
                    </div>
                `;
            } else {
                section.innerHTML = `
                    <div class="phasor-input">
                        <span class="phasor-label seq-pos">V₁</span>
                        <input type="text" id="in1_mag" value="277∠0" placeholder="mag∠angle">
                        <input type="text" id="in1_alt" value="" placeholder="or rect" style="display:none">
                    </div>
                    <div class="phasor-input">
                        <span class="phasor-label seq-neg">V₂</span>
                        <input type="text" id="in2_mag" value="0∠0" placeholder="mag∠angle">
                        <input type="text" id="in2_alt" value="" placeholder="or rect" style="display:none">
                    </div>
                    <div class="phasor-input">
                        <span class="phasor-label seq-zero">V₀</span>
                        <input type="text" id="in3_mag" value="0∠0" placeholder="mag∠angle">
                        <input type="text" id="in3_alt" value="" placeholder="or rect" style="display:none">
                    </div>
                `;
            }
            document.querySelectorAll('#inputSection input').forEach(inp => {
                inp.addEventListener('input', calculate);
            });
            calculate();
        }

        function calculate() {
            const in1 = parsePolar(document.getElementById('in1_mag').value);
            const in2 = parsePolar(document.getElementById('in2_mag').value);
            const in3 = parsePolar(document.getElementById('in3_mag').value);

            let results, labels, colors;
            if (mode === 'abc-to-seq') {
                const { V0, V1, V2 } = abcToSeq(in1, in2, in3);
                results = [V1, V2, V0];
                labels = ['V₁', 'V₂', 'V₀'];
                colors = ['seq-pos', 'seq-neg', 'seq-zero'];
                drawPhasor([in1, in2, in3], [V1, V2, V0], 'abc');
            } else {
                const { Va, Vb, Vc } = seqToAbc(in3, in1, in2);
                results = [Va, Vb, Vc];
                labels = ['Va', 'Vb', 'Vc'];
                colors = ['phase-a', 'phase-b', 'phase-c'];
                drawPhasor([Va, Vb, Vc], [in1, in2, in3], 'seq');
            }

            const section = document.getElementById('resultsSection');
            section.innerHTML = results.map((r, i) => `
                <div class="result-row">
                    <span class="phasor-label ${colors[i]}">${labels[i]}</span>
                    <span class="result-polar">${formatPolar(r)}</span>
                    <span class="result-rect">${formatRect(r)}</span>
                </div>
            `).join('');
        }

        function drawPhasor(abc, seq, inputType) {
            const canvas = document.getElementById('phasorCanvas');
            const ctx = canvas.getContext('2d');
            const w = canvas.width, h = canvas.height;
            const cx = w/2, cy = h/2;

            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, w, h);

            // Grid
            ctx.strokeStyle = '#1d1d1f';
            ctx.lineWidth = 1;
            for (let r = 50; r < 150; r += 50) {
                ctx.beginPath();
                ctx.arc(cx, cy, r, 0, 2*Math.PI);
                ctx.stroke();
            }
            ctx.beginPath();
            ctx.moveTo(0, cy); ctx.lineTo(w, cy);
            ctx.moveTo(cx, 0); ctx.lineTo(cx, h);
            ctx.stroke();

            // Find max mag
            const allMags = [...abc, ...seq].map(c => toPolar(c).mag);
            const maxMag = Math.max(...allMags, 1);
            const scale = 120 / maxMag;

            function drawArrow(c, color, dashed) {
                const p = toPolar(c);
                if (p.mag < 0.01) return;
                const x = cx + c.re * scale;
                const y = cy - c.im * scale;

                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                if (dashed) ctx.setLineDash([6, 4]);
                else ctx.setLineDash([]);

                ctx.beginPath();
                ctx.moveTo(cx, cy);
                ctx.lineTo(x, y);
                ctx.stroke();

                // Arrowhead
                ctx.setLineDash([]);
                const angle = Math.atan2(-(c.im), c.re);
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.moveTo(x, y);
                ctx.lineTo(x - 8*Math.cos(angle-0.3), y + 8*Math.sin(angle-0.3));
                ctx.lineTo(x - 8*Math.cos(angle+0.3), y + 8*Math.sin(angle+0.3));
                ctx.closePath();
                ctx.fill();
            }

            // Draw phase (solid)
            drawArrow(abc[0], '#ff453a', false);
            drawArrow(abc[1], '#30d158', false);
            drawArrow(abc[2], '#0a84ff', false);

            // Draw sequence (dashed)
            drawArrow(seq[0], '#30d158', true);
            drawArrow(seq[1], '#ff453a', true);
            drawArrow(seq[2], '#0a84ff', true);
        }

        // Mode toggle
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                mode = btn.dataset.mode;
                renderInputs();
            });
        });

        document.getElementById('stepToggle').addEventListener('click', () => {
            document.getElementById('stepContent').classList.toggle('open');
        });

        renderInputs();
    </script>
</body>
</html>
