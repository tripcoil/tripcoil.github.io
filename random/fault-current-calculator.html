<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fault Current Calculator</title>
    <link rel="stylesheet" href="tokens.css">
    <style>
        .fault-types {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-sm);
            margin-bottom: var(--space-xl);
        }

        .fault-type {
            padding: var(--space-md);
            background: transparent;
            border: 1px solid var(--bg-hover);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .fault-type:hover {
            border-color: var(--text-secondary);
        }

        .fault-type.active {
            background: var(--bg-hover);
            border-color: var(--text);
            color: var(--text);
        }

        .fault-type-icon {
            font-size: 1.5rem;
            margin-bottom: var(--space-xs);
        }

        .fault-type-label {
            font-size: 0.75rem;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
        }

        .result-card {
            text-align: center;
            padding: var(--space-lg);
            background: var(--bg-subtle);
            border-radius: var(--radius-sm);
        }

        .result-card-value {
            font-size: 1.75rem;
            font-weight: 600;
            font-family: var(--font-mono);
        }

        .result-card-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: var(--space-xs);
        }

        .phase-results {
            font-family: var(--font-mono);
            font-size: 0.9rem;
            line-height: 2;
        }

        .sequence-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-md);
            margin-top: var(--space-lg);
        }

        .seq-card {
            text-align: center;
            padding: var(--space-md);
            background: var(--bg-subtle);
            border-radius: var(--radius-sm);
        }

        .seq-card.pos { border-top: 2px solid var(--seq-pos); }
        .seq-card.neg { border-top: 2px solid var(--seq-neg); }
        .seq-card.zero { border-top: 2px solid var(--seq-zero); }

        .seq-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: var(--space-sm);
        }

        .seq-value {
            font-family: var(--font-mono);
            font-size: 0.85rem;
        }

        .advanced-toggle {
            text-align: center;
            padding: var(--space-md) 0;
            color: var(--text-secondary);
            font-size: 0.875rem;
            cursor: pointer;
        }

        .advanced-toggle:hover {
            color: var(--text);
        }

        .advanced-inputs {
            display: none;
            margin-top: var(--space-lg);
        }

        .advanced-inputs.open {
            display: block;
        }

        @media (max-width: 600px) {
            .fault-types {
                grid-template-columns: repeat(2, 1fr);
            }
            .results-grid,
            .sequence-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <a href="/random/" class="header-back">← Relay Tools</a>
            <span class="header-title">Fault Current</span>
        </header>

        <h1>Fault Current</h1>
        <p class="tagline">Calculate symmetrical and asymmetrical fault currents</p>

        <div class="fault-types">
            <div class="fault-type active" data-type="3ph">
                <div class="fault-type-icon">⚡</div>
                <div class="fault-type-label">3-Phase</div>
            </div>
            <div class="fault-type" data-type="slg">
                <div class="fault-type-icon">⏚</div>
                <div class="fault-type-label">SLG</div>
            </div>
            <div class="fault-type" data-type="ll">
                <div class="fault-type-icon">↔</div>
                <div class="fault-type-label">L-L</div>
            </div>
            <div class="fault-type" data-type="llg">
                <div class="fault-type-icon">⏚↔</div>
                <div class="fault-type-label">L-L-G</div>
            </div>
        </div>

        <div class="input-row">
            <div class="input-group">
                <label>Base MVA</label>
                <input type="number" id="baseMVA" value="100">
            </div>
            <div class="input-group">
                <label>Base kV (L-L)</label>
                <input type="number" id="baseKV" value="138">
            </div>
        </div>

        <div class="input-row">
            <div class="input-group">
                <label>Z₁ (p.u.)</label>
                <input type="text" id="Z1" value="0.1∠85" placeholder="mag∠angle">
            </div>
            <div class="input-group">
                <label>Z₀ (p.u.)</label>
                <input type="text" id="Z0" value="0.3∠80" placeholder="mag∠angle">
            </div>
        </div>

        <div class="advanced-toggle" id="advancedToggle">+ More options</div>
        <div class="advanced-inputs" id="advancedInputs">
            <div class="input-row">
                <div class="input-group">
                    <label>Z₂ (p.u.) — defaults to Z₁</label>
                    <input type="text" id="Z2" value="" placeholder="same as Z₁">
                </div>
                <div class="input-group">
                    <label>Zf Fault Impedance (p.u.)</label>
                    <input type="text" id="Zf" value="0∠0" placeholder="mag∠angle">
                </div>
            </div>
        </div>

        <div class="results-grid">
            <div class="result-card">
                <div class="result-card-value" id="If_pu">--</div>
                <div class="result-card-label">p.u.</div>
            </div>
            <div class="result-card">
                <div class="result-card-value" id="If_A">--</div>
                <div class="result-card-label">Amps</div>
            </div>
            <div class="result-card">
                <div class="result-card-value" id="If_MVA">--</div>
                <div class="result-card-label">MVA</div>
            </div>
        </div>

        <div class="phase-results" id="phaseResults"></div>

        <div class="sequence-grid">
            <div class="seq-card pos">
                <div class="seq-label">Positive I₁</div>
                <div class="seq-value" id="seq_I1">--</div>
            </div>
            <div class="seq-card neg">
                <div class="seq-label">Negative I₂</div>
                <div class="seq-value" id="seq_I2">--</div>
            </div>
            <div class="seq-card zero">
                <div class="seq-label">Zero I₀</div>
                <div class="seq-value" id="seq_I0">--</div>
            </div>
        </div>

        <div class="drawer-trigger" id="stepToggle">See calculation →</div>
        <div class="step-content" id="stepContent"></div>
    </div>

    <script>
        let faultType = '3ph';
        const a_re = -0.5, a_im = Math.sqrt(3)/2;
        const a2_re = -0.5, a2_im = -Math.sqrt(3)/2;

        // Parse polar notation: "0.1∠85" or "0.1<85" or "0.1 85"
        function parsePolar(str) {
            if (!str || str.trim() === '') return null;
            str = str.trim().replace(/</g, '∠').replace(/\s+/g, '∠');
            const match = str.match(/^([+-]?[\d.]+)∠([+-]?[\d.]+)$/);
            if (match) {
                const mag = parseFloat(match[1]);
                const angDeg = parseFloat(match[2]);
                const angRad = angDeg * Math.PI / 180;
                return { re: mag * Math.cos(angRad), im: mag * Math.sin(angRad) };
            }
            // Try just a number
            const num = parseFloat(str);
            if (!isNaN(num)) return { re: num, im: 0 };
            return null;
        }

        function rectToPolar(re, im) {
            return { mag: Math.sqrt(re*re + im*im), ang: Math.atan2(im, re) * 180 / Math.PI };
        }

        function formatPolar(c) {
            const p = rectToPolar(c.re, c.im);
            return `${p.mag.toFixed(3)}∠${p.ang.toFixed(1)}°`;
        }

        function complexAdd(a, b) { return { re: a.re + b.re, im: a.im + b.im }; }
        function complexMult(a, b) { return { re: a.re*b.re - a.im*b.im, im: a.re*b.im + a.im*b.re }; }
        function complexDiv(a, b) {
            const denom = b.re*b.re + b.im*b.im;
            if (denom === 0) return { re: 0, im: 0 };
            return { re: (a.re*b.re + a.im*b.im)/denom, im: (a.im*b.re - a.re*b.im)/denom };
        }

        function calculate() {
            const baseMVA = parseFloat(document.getElementById('baseMVA').value) || 100;
            const baseKV = parseFloat(document.getElementById('baseKV').value) || 138;
            const baseI = baseMVA * 1000 / (Math.sqrt(3) * baseKV);

            const Z1 = parsePolar(document.getElementById('Z1').value) || { re: 0.1, im: 0 };
            const Z0 = parsePolar(document.getElementById('Z0').value) || { re: 0.3, im: 0 };
            const Z2input = document.getElementById('Z2').value.trim();
            const Z2 = Z2input ? parsePolar(Z2input) : Z1;
            const Zf = parsePolar(document.getElementById('Zf').value) || { re: 0, im: 0 };

            const Vf = { re: 1.0, im: 0 };
            let I0 = { re: 0, im: 0 };
            let I1 = { re: 0, im: 0 };
            let I2 = { re: 0, im: 0 };
            let formula = '';

            if (faultType === '3ph') {
                const Ztotal = complexAdd(Z1, Zf);
                I1 = complexDiv(Vf, Ztotal);
                formula = `Three-Phase Fault\nI₁ = Vf / (Z₁ + Zf) = ${formatPolar(I1)} p.u.\nI₂ = 0, I₀ = 0`;

            } else if (faultType === 'slg') {
                const Zf3 = { re: 3*Zf.re, im: 3*Zf.im };
                const Ztotal = complexAdd(complexAdd(complexAdd(Z0, Z1), Z2), Zf3);
                const Iseq = complexDiv(Vf, Ztotal);
                I0 = Iseq; I1 = Iseq; I2 = Iseq;
                formula = `SLG Fault (A-G)\nI₀ = I₁ = I₂ = Vf / (Z₀ + Z₁ + Z₂ + 3Zf)\n= ${formatPolar(I1)} p.u.`;

            } else if (faultType === 'll') {
                const Ztotal = complexAdd(complexAdd(Z1, Z2), Zf);
                I1 = complexDiv(Vf, Ztotal);
                I2 = { re: -I1.re, im: -I1.im };
                formula = `L-L Fault (B-C)\nI₁ = Vf / (Z₁ + Z₂ + Zf) = ${formatPolar(I1)} p.u.\nI₂ = -I₁, I₀ = 0`;

            } else if (faultType === 'llg') {
                const Z0_3Zf = complexAdd(Z0, { re: 3*Zf.re, im: 3*Zf.im });
                const Zpar_num = complexMult(Z2, Z0_3Zf);
                const Zpar_den = complexAdd(Z2, Z0_3Zf);
                const Zpar = complexDiv(Zpar_num, Zpar_den);
                const Ztotal = complexAdd(Z1, Zpar);
                I1 = complexDiv(Vf, Ztotal);
                I2 = complexMult({ re: -I1.re, im: -I1.im }, complexDiv(Z0_3Zf, Zpar_den));
                I0 = complexMult({ re: -I1.re, im: -I1.im }, complexDiv(Z2, Zpar_den));
                formula = `L-L-G Fault (B-C-G)\nI₁ = Vf / (Z₁ + Z₂||(Z₀+3Zf)) = ${formatPolar(I1)} p.u.`;
            }

            // Phase currents
            const a = { re: a_re, im: a_im };
            const a2 = { re: a2_re, im: a2_im };
            const Ia = complexAdd(complexAdd(I0, I1), I2);
            const Ib = complexAdd(complexAdd(I0, complexMult(a2, I1)), complexMult(a, I2));
            const Ic = complexAdd(complexAdd(I0, complexMult(a, I1)), complexMult(a2, I2));

            let If_mag;
            if (faultType === '3ph') {
                If_mag = rectToPolar(I1.re, I1.im).mag;
            } else if (faultType === 'slg') {
                If_mag = 3 * rectToPolar(I0.re, I0.im).mag;
            } else {
                If_mag = Math.max(
                    rectToPolar(Ia.re, Ia.im).mag,
                    rectToPolar(Ib.re, Ib.im).mag,
                    rectToPolar(Ic.re, Ic.im).mag
                );
            }

            const If_amps = If_mag * baseI;
            const If_MVA = Math.sqrt(3) * baseKV * If_amps / 1000;

            // Update display
            document.getElementById('If_pu').textContent = If_mag.toFixed(2);
            document.getElementById('If_A').textContent = If_amps.toFixed(0);
            document.getElementById('If_MVA').textContent = If_MVA.toFixed(0);

            const IaMag = rectToPolar(Ia.re, Ia.im).mag;
            const IbMag = rectToPolar(Ib.re, Ib.im).mag;
            const IcMag = rectToPolar(Ic.re, Ic.im).mag;

            document.getElementById('phaseResults').innerHTML =
                `<span class="phase-a">Ia = ${formatPolar(Ia)} = ${(IaMag * baseI).toFixed(0)} A</span><br>` +
                `<span class="phase-b">Ib = ${formatPolar(Ib)} = ${(IbMag * baseI).toFixed(0)} A</span><br>` +
                `<span class="phase-c">Ic = ${formatPolar(Ic)} = ${(IcMag * baseI).toFixed(0)} A</span>`;

            document.getElementById('seq_I1').textContent = formatPolar(I1);
            document.getElementById('seq_I2').textContent = formatPolar(I2);
            document.getElementById('seq_I0').textContent = formatPolar(I0);

            document.getElementById('stepContent').innerHTML =
                `<div class="step-section"><div class="step-title">Calculation</div><pre>${formula}</pre></div>`;
        }

        // Fault type selection
        document.querySelectorAll('.fault-type').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.fault-type').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                faultType = btn.dataset.type;
                calculate();
            });
        });

        // Advanced toggle
        document.getElementById('advancedToggle').addEventListener('click', () => {
            const inputs = document.getElementById('advancedInputs');
            const toggle = document.getElementById('advancedToggle');
            inputs.classList.toggle('open');
            toggle.textContent = inputs.classList.contains('open') ? '− Less options' : '+ More options';
        });

        // Step toggle
        document.getElementById('stepToggle').addEventListener('click', () => {
            document.getElementById('stepContent').classList.toggle('open');
        });

        // Auto-calculate on input
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', calculate);
        });

        // Initial calculation
        calculate();
    </script>
</body>
</html>
